<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 3</title>
    <script src="//cdn.jsdelivr.net/phaser/2.2.2/phaser.min.js"></script>
    <script src="Tetromino.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

    var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

    var landed = [];

    var cubesize = 32;

    var tetromino = null;

    var cursors;

    var moveLeftKey;
    var moveRightKey;

    function preload() {

        game.load.image('cube', 'blocks/RED_block_1.png');
    }

    function create() {


        game.physics.startSystem(Phaser.Physics.ARCADE);
        createTetromino();
        tetromino.enableBody = true;
        game.input.mouse.capture = true;

        for (var i=0;i<15;i++) {
            landed[i] = [];
            for(var j = 0; j<15; j++)
                landed[i][j]=0;
        }



        game.time.events.loop(Phaser.Timer.SECOND * 1, progressTetromino,  this);

        cursors = game.input.keyboard.createCursorKeys();
        moveLeftKey = game.input.keyboard.addKey(Phaser.Keyboard.LEFT);
        moveRightKey = game.input.keyboard.addKey(Phaser.Keyboard.RIGHT);

    }

    function update() {

        game.input.onDown.add(rotate, this);
        //cursors.up.isDown.add(progressTetromino,this);
        if (moveLeftKey.justUp)
        {

            tetromino.moveTetromino('left');
        }
        else if (moveRightKey.justUp)
        {

            tetromino.moveTetromino('right');
        }


        for (var i=0;i<10;i++) {
            for(var j = 0; j<10; j++)
                if(landed[i][j]!=0)
                    game.add.sprite(i * cubesize, j * cubesize, 'cube');
        }


    }
    function progressTetromino() {

        tetromino.moveTetromino('down');
        var land = false;
        var potentialTopLeft = tetromino.topLeft;
        potentialTopLeft.y++;
        for (var row = 0; row < tetromino.shape.length; row++) {
            for (var col = 0; col < tetromino.shape[row].length; col++) {
                if (tetromino.shape[row][col] != 0) {
                    if ((row + potentialTopLeft.x >= landed.length)) {
                        land = true;
                    }
                    else if ((landed[row + potentialTopLeft.x][col + potentialTopLeft.y] != 0)) {
                        land = true;
                    }
                }
            }
        }
        if(land)
        for (var row = 0; row < tetromino.shape.length; row++) {
            for (var col = 0; col < tetromino.shape[row].length; col++) {
                if (tetromino.shape[row][col] != 0) {
                    landed[row + tetromino.topLeft.x][col + tetromino.topLeft.y] = tetromino.shape[row][col];
                    tetromino.destroy();
                }
            }
        }

    }
    function createTetromino(){

        var topLeft = new Phaser.Point(4,4);
        tetromino = new Tetromino(this.game,topLeft,0,'T');

    }

    function rotate(){

        tetromino.squares[0].destroy();
        tetromino.squares[1].destroy();
        tetromino.squares[2].destroy();
        tetromino.squares[3].destroy();

        var newRotation = tetromino.currentRotation;
        if(newRotation<3) newRotation++;
        else newRotation = 0;
        tetromino = new Tetromino(this.game,tetromino.topLeft,newRotation,tetromino.type);


    }



</script>

</body>
</html>
